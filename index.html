<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>너와 나의 불협화음, 머신러닝으로 새롭게</title>
    <!-- TensorFlow.js 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Teachable Machine 음성 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/audio"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        .model-section {
            margin-bottom: 60px;
        }
        .model-section h2 {
            margin-bottom: 20px;
        }
        audio {
            margin-top: 10px;
        }
        .qr-codes img {
            width: 45%;
            margin: 2.5%;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 1em;
        }
        #prediction {
            margin-top: 10px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>너와 나의 불협화음, 머신러닝으로 새롭게</h1>
    <p>이 프로젝트는 티처블 머신을 사용하여 학생들이 불협화음을 분석하고, 이를 통해 수학적 원리를 이해하는 것을 목표로 합니다.</p>

    <!-- 팀별 모델 섹션 -->
    <div class="model-section">
        <h2>팀1: 서지원</h2>
        <p>음성 모델을 사용하여 불협화음을 분류합니다.</p>
        <button onclick="startPrediction('team1')">모델 로드 및 예측 시작</button>
        <div id="prediction-team1">예측 결과: 없음</div>
    </div>

    <div class="model-section">
        <h2>팀2: 정혜안, 임유건</h2>
        <p>음성 모델을 사용하여 불협화음을 분류합니다.</p>
        <button onclick="startPrediction('team2')">모델 로드 및 예측 시작</button>
        <div id="prediction-team2">예측 결과: 없음</div>
    </div>

    <div class="model-section">
        <h2>팀3: 홍대건</h2>
        <p>음성 모델을 사용하여 불협화음을 분류합니다.</p>
        <button onclick="startPrediction('team3')">모델 로드 및 예측 시작</button>
        <div id="prediction-team3">예측 결과: 없음</div>
    </div>

    <!-- QR 코드 섹션 -->
    <h2>QR 코드로 직접 시연</h2>
    <div class="qr-codes">
        <img src="https://hackmd.io/_uploads/S1WObvqT0.png" alt="QR 코드1">
        <img src="https://hackmd.io/_uploads/Sk0DPPcT0.png" alt="QR 코드2">
    </div>

    <!-- JavaScript: 모델 로드 및 예측 함수 -->
    <script>
        const models = {
            'team1': {
                modelURL: 'team1/model.json',
                metadataURL: 'team1/metadata.json'
            },
            'team2': {
                modelURL: 'team2/model.json',
                metadataURL: 'team2/metadata.json'
            },
            'team3': {
                modelURL: 'team3/model.json',
                metadataURL: 'team3/metadata.json'
            }
        };

        const loadedModels = {};

        async function loadModel(team) {
            const modelURL = models[team].modelURL;
            const metadataURL = models[team].metadataURL;
            const model = await tmAudio.load(modelURL, metadataURL);
            loadedModels[team] = model;
        }

        async function startPrediction(team) {
            if (!loadedModels[team]) {
                await loadModel(team);
            }
            const model = loadedModels[team];
            // 마이크 권한 요청
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(2048, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                let audioData = [];

                processor.onaudioprocess = async function(e) {
                    const input = e.inputBuffer.getChannelData(0);
                    audioData.push(...input);
                    // 충분한 데이터 수집 후 예측
                    if (audioData.length > 44100) { // 약 1초 분량 (44,100 샘플 at 44.1kHz)
                        processor.disconnect();
                        source.disconnect();
                        stream.getTracks().forEach(track => track.stop());
                        const audioBuffer = new Float32Array(audioData);
                        const prediction = await model.predict(audioBuffer);
                        let resultText = "예측 결과: ";
                        prediction.forEach(pred => {
                            resultText += `${pred.className}: ${(pred.probability * 100).toFixed(2)}% `;
                        });
                        document.getElementById(`prediction-${team}`).innerHTML = resultText;
                    }
                };
            } catch (err) {
                console.error('마이크 접근 오류:', err);
                alert('마이크에 접근할 수 없습니다.');
            }
        }
    </script>
</body>
</html>
